<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<title>Google Map</title>
		<style>
			html {
				height: 100%
			}
			body {
				height: 100%;
				margin: 0;
				padding: 0
			}
			.mapIconLabel {
				font-size: 14px;
				font-weight: bold;
				color: #FFFFFF;
			}
		</style>
		<script src="https://maps.googleapis.com/maps/api/js?sensor=false&language=zh-tw"></script>
		<script src="geolocationmarker-compiled.js"></script>
		<script src="markerwithlabel.js"></script>
		<script>
            var map,
                GeoMarker,
                droneMarkerOuter,
                droneMarkerInner,
                droneMarkerArrow,
                markIcon;
            var markers = [];
            var poly;

            function initialize() {
                var latlng;
                latlng = new google.maps.LatLng(24.712299, 120.916408);
                // 中強光電竹南廠
                //latlng = new google.maps.LatLng(25.033908, 121.565003); // 台北101

                var styleArray = [{
                    featureType : "poi",
                    elementType : "all",
                    stylers : [{
                        visibility : "off"
                    }]
                }, {
                    featureType : "transit",
                    elementType : "all",
                    stylers : [{
                        visibility : "off"
                    }]
                }];

                var mapOptions = {
                    center : latlng,
                    zoom : 15,
                    mapTypeId : google.maps.MapTypeId.ROAD,
                    disableDefaultUI : true,
                    // mapTypeControl : true,
                    // mapTypeControlOptions : {
                    // position : google.maps.ControlPosition.LEFT_CENTER
                    // },
                    // zoomControl : true,
                    // zoomControlOptions : {
                    // style : google.maps.ZoomControlStyle.SMALL,
                    // position : google.maps.ControlPosition.LEFT_CENTER
                    // },
                    styles : styleArray
                };
                map = new google.maps.Map(document.getElementById("map"), mapOptions);

                GeoMarker = new GeolocationMarker(map);

                var polyOptions = {
                    strokeColor : '#4EC3F5',
                    strokeOpacity : 1.0,
                    strokeWeight : 3,
                    clickable : false,
                    map : map
                };
                poly = new google.maps.Polyline(polyOptions);
                
                var droneMarkerOuterOption = {
                	icon : {
                		path : 'M40,14.7c3.5,10.5-2.2,21.8-12.7,25.3C16.8,43.5,5.5,37.8,2,27.3S4.2,5.5,14.7,2C25.2-1.5,36.5,4.2,40,14.7L40,14.7z',
                		strokeColor : '#000000',
                		strokeOpacity : 0.4,
                		fillColor : '#000000',
                		fillOpacity : 0.4,
                        anchor: new google.maps.Point(21, 21),
                		scale : 1
                	},
                	zIndex : 97,
                	map : map
                };
                
                var droneMarkerInnerOption = {
                	icon : {
                		path : 'M30.5,17.9c1.7,5.2-1.1,10.9-6.4,12.6c-5.2,1.7-10.9-1.1-12.6-6.4c-1.7-5.2,1.1-10.9,6.4-12.6C23.1,9.8,28.8,12.6,30.5,17.9L30.5,17.9z',
                		strokeColor : '#ffffff',
                		fillColor : '#ffffff',
                		fillOpacity : 1,
                        anchor: new google.maps.Point(21, 21),
                		scale : 1
                	},
                	zIndex : 98,
                	map : map
                };

                var droneMarkerArrowOption = {
                    icon : {
                        path :'M20.9,13L26,26.9c0,0-5-3.7-5.1-3.7c0,0-4.9,3.8-4.9,3.8L20.9,13L20.9,13z',
                        strokeColor : '#ff8800',
                        fillColor : '#ff8800',
                        fillOpacity : 1,
                        anchor: new google.maps.Point(21, 21),
                        rotation : 0,
                        scale : 1
                    },
                	zIndex : 99,
                    map : map
                };
                
                droneMarkerOuter = new google.maps.Marker(droneMarkerOuterOption);
                droneMarkerInner = new google.maps.Marker(droneMarkerInnerOption);
                droneMarkerArrow = new google.maps.Marker(droneMarkerArrowOption);

                google.maps.event.addListener(map, 'click', addLatLng);

                // updateDroneLocation(24.712299, 120.916408);
            }

            function addLatLng(event) {
                AndroidFunction.addWaypointToList(event.latLng.lat(), event.latLng.lng());

                // addMarker(event.latLng.lat(), event.latLng.lng(), poly.getPath().getLength() + 1);
            }

            function addMarker(lat, lng, sn) {
                var x = 4;
                if (sn > 9) {
                    x = 8;
                }
                var markerImage = {
                    url : 'ico_indicator_waypoint_circle.png',
                    // This marker is 20 pixels wide by 32 pixels tall.
                    size : new google.maps.Size(40, 40),
                    // The origin for this image is 0,0.
                    origin : new google.maps.Point(0, 0),
                    // The anchor for this image is the base of the flagpole at 0,32.
                    anchor : new google.maps.Point(20, 20)
                };
                var marker = new MarkerWithLabel({
                    position : new google.maps.LatLng(lat, lng),
                    icon : markerImage,
                    labelContent : sn,
                    labelAnchor : new google.maps.Point(x, 8),
                    labelClass : "mapIconLabel",
                    labelInBackground : false,
                    map : map
                });
                markers.push(marker);

                var path = poly.getPath();
                path.push(new google.maps.LatLng(lat, lng));
                poly.setMap(map);
            }

            function setMapToMyLocation() {
                var currPosition = null;

                currPosition = GeoMarker.getPosition();
                if (currPosition != null) {
                    setMapTo(currPosition.lat(), currPosition.lng());
                } else {
                    AndroidFunction.showToast("無法取得現在位置");
                }
                if(map.getZoom() <15 ){
                	map.setZoom(15);
                }
            }

            function setMapTo(nowLatget, nowLngget) {
                map.setCenter(new google.maps.LatLng(nowLatget, nowLngget));
            }

            function clearMarkers() {
                var i,
                    j;
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    markers[i].setMap(null);
                }
                markers = [];

                poly.setMap(null);
                poly.setPath([]);
            }

            function deleteSelectMarker(selected) {
                markers[selected].setMap(null);
                var path = poly.getPath();
                path.removeAt(selected);
                markers.splice(selected, 1);
                poly.setpath(path);
                poly.setMap(map);
            }

            function updateDroneLocation(droneLat, droneLng, heading) {
            	droneMarkerOuter.setMap(null);
            	droneMarkerInner.setMap(null);
                droneMarkerArrow.setMap(null);
                droneMarkerArrow.icon.rotation = heading;
                droneMarkerOuter.setPosition(new google.maps.LatLng(droneLat, droneLng));
                droneMarkerInner.setPosition(new google.maps.LatLng(droneLat, droneLng));
                droneMarkerArrow.setPosition(new google.maps.LatLng(droneLat, droneLng));
                droneMarkerOuter.setMap(map);
                droneMarkerInner.setMap(map);
                droneMarkerArrow.setMap(map);
            }

            function fitMapShowAll() {
            	var i, j;
                var bounds = new google.maps.LatLngBounds();
                for (i = 0, j = markers.length; i < j; i++) {
                    bounds.extend(markers[i].position);
                }
                map.fitBounds(bounds);
            }
            
            function hideMarkerOnMap(){
            	var i, j;
            	for (i = 0, j = markers.length; i < j; i++){
            		markers[i].setMap(null);
            	}
            	poly.setMap(null);
            }
            
            function showMarkerOnMap(){
            	var i, j;
            	for (i = 0, j = markers.length; i < j; i++){
            		markers[i].setMap(map);
            	}
            	poly.setMap(map);            	
            }
            
		</script>
	</head>
	<body onload="initialize()">
		<div id="map" style="width: 100%; height: 100%;"> </div>
	</body>
</html>