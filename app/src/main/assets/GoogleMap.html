<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<title>Google Map</title>
		<style>
			html {
				height: 100%
			}
			body {
				height: 100%;
				margin: 0;
				padding: 0
			}
			.mapIconLabel {
				font-size: 14px;
				font-weight: bold;
				color: #FFFFFF;
			}
			.startMarkerLabel {
				font-size: 14px;
				font-weight: bold;
				color: #00FF00;
			}
			.endMarkerLabel {
				font-size: 14px;
				font-weight: bold;
				color: #FF0000;
			}
		</style>
		<script src="https://maps.googleapis.com/maps/api/js?sensor=false&language=zh-tw&libraries=geometry"></script>
		<script src="geolocationmarker-compiled.js"></script>
		<script src="markerwithlabel.js"></script>
		<script>
            var map,
                GeoMarker,
                droneMarkerOuter,
                droneMarkerInner,
                droneMarkerArrow,
                mapClickable;
            var markers = [];
            var poly;
            var flightPath;
            var flightPlanCoordinates = [];
            var historyMarkers = [];
            var droneLat_old = -1;
            var droneLng_old = -1;
            var droneHeading_old = 0;

            function initialize() {
                var initial_location;
                initial_location = new google.maps.LatLng(24.712299, 120.916408);
                // 中強光電竹南廠

                mapClickable = true;

                var styleArray = [{
                    featureType : "poi",
                    elementType : "all",
                    stylers : [{
                        visibility : "off"
                    }]
                }, {
                    featureType : "transit",
                    elementType : "all",
                    stylers : [{
                        visibility : "off"
                    }]
                }];

                var mapOptions = {
                    center : initial_location,
                    zoom : 15,
                    mapTypeId : google.maps.MapTypeId.ROAD,
                    disableDefaultUI : true,
                    mapTypeControl : true,
                    mapTypeControlOptions : {
                        position : google.maps.ControlPosition.LEFT_CENTER
                    },
                    // zoomControl : true,
                    // zoomControlOptions : {
                    // style : google.maps.ZoomControlStyle.SMALL,
                    // position : google.maps.ControlPosition.LEFT_CENTER
                    // },
                    styles : styleArray
                };
                map = new google.maps.Map(document.getElementById("map"), mapOptions);

                var GeoMarkerOption = {
                    icon : {
                        path : google.maps.SymbolPath.CIRCLE,
                        scale : 10,
                        strokeColor : '#34a7ff',
                        strokeOpacity : 1,
                        fillColor : '#34a7ff',
                        fillOpacity : 1
                    }
                }

                GeoMarker = new GeolocationMarker(map, GeoMarkerOption);
                GeoMarker.setCircleOptions({
                    fillColor : '#34a7ff',
                    strokeColor : '#34a7ff',
                    strokeOpacity : 1,
                    strokeWeight : 2
                });

                var polyOptions = {
                    strokeColor : '#4EC3F5',
                    strokeOpacity : 1.0,
                    strokeWeight : 3,
                    clickable : false,
                    map : map
                };
                poly = new google.maps.Polyline(polyOptions);

                var droneMarkerOuterOption = {
                    icon : {
                        path : 'M40,14.7c3.5,10.5-2.2,21.8-12.7,25.3C16.8,43.5,5.5,37.8,2,27.3S4.2,5.5,14.7,2C25.2-1.5,36.5,4.2,40,14.7L40,14.7z',
                        strokeColor : '#000000',
                        strokeOpacity : 0.4,
                        fillColor : '#000000',
                        fillOpacity : 0.4,
                        anchor : new google.maps.Point(21, 21),
                        scale : 1
                    },
                    zIndex : 97,
                    map : map
                };

                var droneMarkerInnerOption = {
                    icon : {
                        path : 'M30.5,17.9c1.7,5.2-1.1,10.9-6.4,12.6c-5.2,1.7-10.9-1.1-12.6-6.4c-1.7-5.2,1.1-10.9,6.4-12.6C23.1,9.8,28.8,12.6,30.5,17.9L30.5,17.9z',
                        strokeColor : '#ffffff',
                        fillColor : '#ffffff',
                        fillOpacity : 1,
                        anchor : new google.maps.Point(21, 21),
                        scale : 1
                    },
                    zIndex : 98,
                    map : map
                };

                var droneMarkerArrowOption = {
                    icon : {
                        path : 'M20.9,13L26,26.9c0,0-5-3.7-5.1-3.7c0,0-4.9,3.8-4.9,3.8L20.9,13L20.9,13z',
                        strokeColor : '#ff8800',
                        fillColor : '#ff8800',
                        fillOpacity : 1,
                        anchor : new google.maps.Point(21, 21),
                        rotation : 0,
                        scale : 1
                    },
                    zIndex : 99,
                    map : map
                };

                droneMarkerOuter = new google.maps.Marker(droneMarkerOuterOption);
                droneMarkerInner = new google.maps.Marker(droneMarkerInnerOption);
                droneMarkerArrow = new google.maps.Marker(droneMarkerArrowOption);

                google.maps.event.addListener(map, 'click', addLatLng);

                // updateDroneLocation(24.712299, 120.916408);

                flightPath = new google.maps.Polyline({
                    path : flightPlanCoordinates,
                    geodesic : true,
                    strokeColor : '#4EC3F5',
                    strokeOpacity : 1.0,
                    strokeWeight : 6
                });
            }

            function setMapClickable(isClickable) {
                mapClickable = isClickable;
            }

            function addLatLng(event) {
                if (mapClickable) {
                    AndroidFunction.addWaypointToList(event.latLng.lat(), event.latLng.lng());

                    // addMarker(event.latLng.lat(), event.latLng.lng(), poly.getPath().getLength() + 1);
                }
            }

            function addMarker(lat, lng, sn) {
                var x = 4;
                if (sn > 9) {
                    x = 8;
                }
                var markerImage = {
                    url : 'ico_indicator_waypoint_circle.png',
                    size : new google.maps.Size(40, 40),
                    origin : new google.maps.Point(0, 0),
                    anchor : new google.maps.Point(20, 20)
                };
                var marker = new MarkerWithLabel({
                    position : new google.maps.LatLng(lat, lng),
                    icon : markerImage,
                    labelContent : sn,
                    labelAnchor : new google.maps.Point(x, 8),
                    labelClass : "mapIconLabel",
                    labelInBackground : false,
                    map : map
                });
                markers.push(marker);

                var path = poly.getPath();
                path.push(new google.maps.LatLng(lat, lng));
                poly.setMap(map);
            }

            function setMapToMyLocation() {
                var currPosition = null;

                currPosition = GeoMarker.getPosition();
                if (currPosition != null) {
                    map.setCenter(currPosition);
                } else {
                    AndroidFunction.showToast("無法取得現在位置");
                }
                if (map.getZoom() < 15) {
                    map.setZoom(15);
                }
            }

            function setMapTo(nowLatget, nowLngget) {
                var nlat = nowLatget / Math.pow(10, 7);
                var nlng = nowLngget / Math.pow(10, 7);
                map.setCenter(new google.maps.LatLng(nlat, nlng));
            }

            function clearMarkers() {
                var i,
                    j;
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    markers[i].setMap(null);
                }
                markers = [];

                poly.setMap(null);
                poly.setPath([]);
            }

            function deleteSelectMarker(selected) {
                markers[selected].setMap(null);
                var path = poly.getPath();
                path.removeAt(selected);
                markers.splice(selected, 1);
                poly.setpath(path);
                poly.setMap(map);
            }

            function updateDroneLocation(droneLat, droneLng, heading) {
                if (droneLat_old != droneLat || droneLng_old != droneLng || droneHeading_old != heading) {
                    droneLat_old = droneLat;
                    droneLng_old = droneLng;
                    droneHeading_old = heading;

                    var lat = droneLat / Math.pow(10, 7);
                    var lng = droneLng / Math.pow(10, 7);
                    droneMarkerOuter.setMap(null);
                    droneMarkerInner.setMap(null);
                    droneMarkerArrow.setMap(null);
                    droneMarkerArrow.icon.rotation = heading;
                    droneMarkerOuter.setPosition(new google.maps.LatLng(droneLat, droneLng));
                    droneMarkerInner.setPosition(new google.maps.LatLng(droneLat, droneLng));
                    droneMarkerArrow.setPosition(new google.maps.LatLng(droneLat, droneLng));
                    droneMarkerOuter.setMap(map);
                    droneMarkerInner.setMap(map);
                    droneMarkerArrow.setMap(map);
                }
            }

            function fitMapShowAll() {
                var i,
                    j;
                var bounds = new google.maps.LatLngBounds();
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    bounds.extend(markers[i].position);
                }
                map.fitBounds(bounds);
            }

            function fitMapShowDroneAndMe() {
                var droneBound = new google.maps.LatLngBounds();
                droneBound.extend(droneMarkerOuter.position);
                droneBound.extend(GeoMarker.getPosition());

                map.fitBounds(droneBound);
            }

            function hideMarkerOnMap() {
                var i,
                    j;
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    markers[i].setMap(null);
                }
                poly.setMap(null);
            }

            function showMarkerOnMap() {
                var i,
                    j;
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    markers[i].setMap(map);
                }
                poly.setMap(map);
            }

            function setMarkerShow(isMarkerShow) {
                var i,
                    j,
                    option;
                if (isMarkerShow) {
                    option = map;
                } else {
                    option = null;
                }
                for ( i = 0,
                j = markers.length; i < j; i++) {
                    markers[i].setMap(option);
                }
                poly.setMap(option);
            }

            function LoadPathLog(markerJson, pathJson) {
                var i,
                    j,
                    lat,
                    lng;

                var pathData = JSON.parse("[" + pathJson + "]");
                var markerData = JSON.parse("[" + markerJson + "]");

                var markerImage = {
                    url : 'ico_indicator_waypoint_circle.png',
                    size : new google.maps.Size(40, 40),
                    origin : new google.maps.Point(0, 0),
                    anchor : new google.maps.Point(20, 20)
                };

                ClearPath();

                for ( i = 0,
                j = pathData.length; i < j; i += 2) {
                    lat = pathData[i] / Math.pow(10, 7);
                    lng = pathData[i + 1] / Math.pow(10, 7);
                    flightPlanCoordinates.push(new google.maps.LatLng(lat, lng));
                }

                if (flightPlanCoordinates.length > 1) {
                    var startMarker = new MarkerWithLabel({
                        position : flightPlanCoordinates[0],
                        icon : {
                            path : google.maps.SymbolPath.CIRCLE,
                            scale : 8,
                            strokeColor : '#000',
                            fillColor : '#000',
                            fillOpacity : 1.0
                        },
                        labelAnchor : new google.maps.Point(4, 8),
                        labelContent : 'S',
                        labelClass : "startMarkerLabel",
                        labelInBackground : false,
                        map : map
                    });
                    historyMarkers.push(startMarker);

                    var endMarker = new MarkerWithLabel({
                        position : flightPlanCoordinates[flightPlanCoordinates.length - 1],
                        icon : {
                            path : google.maps.SymbolPath.CIRCLE,
                            scale : 8,
                            strokeColor : '#000',
                            fillColor : '#000',
                            fillOpacity : 1.0
                        },
                        labelAnchor : new google.maps.Point(4, 8),
                        labelContent : 'E',
                        labelClass : "endMarkerLabel",
                        labelInBackground : false,
                        map : map
                    });
                    historyMarkers.push(endMarker);
                }

                for ( i = 0,
                j = markerData.length; i < j; i += 2) {

                    var x = 4;
                    if (i > 18) {
                        x = 8;
                    }
                    var flightMarker = new MarkerWithLabel({
                        position : new google.maps.LatLng(markerData[i], markerData[i + 1]),
                        icon : markerImage,
                        labelContent : (i / 2) + 1,
                        labelAnchor : new google.maps.Point(x, 8),
                        labelClass : "mapIconLabel",
                        labelInBackground : false,
                        map : map
                    });

                    historyMarkers.push(flightMarker);
                }

                flightPath.setPath(flightPlanCoordinates);
                flightPath.setMap(map);

                var flightbounds = new google.maps.LatLngBounds();
                for ( i = 0,
                j = flightPlanCoordinates.length; i < j; i++) {
                    flightbounds.extend(flightPlanCoordinates[i]);
                }
                map.fitBounds(flightbounds);
                
                var lengthInMeters = google.maps.geometry.spherical.computeLength(flightPath.getPath());
                AndroidFunction.setPolylineLengthText(lengthInMeters);
            }

            function ClearPath() {
                flightPath.setMap(null);
                flightPath.setPath([]);
                flightPlanCoordinates = [];

                var i,
                    j;
                for ( i = 0,
                j = historyMarkers.length; i < j; i++) {
                    historyMarkers[i].setMap(null);
                }
                historyMarkers = [];
            }

		</script>
	</head>
	<body onload="initialize()">
		<div id="map" style="width: 100%; height: 100%;"> </div>
	</body>
</html>